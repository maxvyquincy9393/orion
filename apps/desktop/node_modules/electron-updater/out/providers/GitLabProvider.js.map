{"version":3,"file":"GitLabProvider.js","sourceRoot":"","sources":["../../src/providers/GitLabProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import { CancellationToken, GitlabOptions, HttpError, newError, UpdateFileInfo, UpdateInfo, GitlabReleaseInfo, GitlabReleaseAsset } from \"builder-util-runtime\"\nimport { URL } from \"url\"\n// @ts-ignore\nimport * as escapeRegExp from \"lodash.escaperegexp\"\nimport { AppUpdater } from \"../AppUpdater\"\nimport { ResolvedUpdateFileInfo } from \"../types\"\nimport { getChannelFilename, newBaseUrl, newUrlFromBase } from \"../util\"\nimport { getFileList, parseUpdateInfo, Provider, ProviderRuntimeOptions } from \"./Provider\"\n\ninterface GitlabUpdateInfo extends UpdateInfo {\n  tag: string\n  assets: Map<string, string> // filename -> download URL mapping\n}\n\nexport class GitLabProvider extends Provider<GitlabUpdateInfo> {\n  private readonly baseApiUrl: URL\n  // Cache the latest version info to avoid unnecessary HTTP requests\n  private cachedLatestVersion: GitlabUpdateInfo | null = null\n\n  /**\n   * Normalizes filenames by replacing spaces and underscores with dashes.\n   *\n   * This is a workaround to handle filename formatting differences between tools:\n   * - electron-builder formats filenames like \"test file.txt\" as \"test-file.txt\"\n   * - GitLab may provide asset URLs using underscores, such as \"test_file.txt\"\n   *\n   * Because of this mismatch, we can't reliably extract the correct filename from\n   * the asset path without normalization. This function ensures consistent matching\n   * across different filename formats by converting all spaces and underscores to dashes.\n   *\n   * @param filename The filename to normalize\n   * @returns The normalized filename with spaces and underscores replaced by dashes\n   */\n  private normalizeFilename(filename: string): string {\n    return filename.replace(/ |_/g, \"-\")\n  }\n\n  constructor(\n    private readonly options: GitlabOptions,\n    private readonly updater: AppUpdater,\n    runtimeOptions: ProviderRuntimeOptions\n  ) {\n    super({\n      ...runtimeOptions,\n      // GitLab might not support multiple range requests efficiently\n      isUseMultipleRangeRequest: false,\n    })\n\n    const defaultHost = \"gitlab.com\"\n    const host = options.host || defaultHost\n\n    this.baseApiUrl = newBaseUrl(`https://${host}/api/v4`)\n  }\n\n  private get channel(): string {\n    const result = this.updater.channel || this.options.channel\n    return result == null ? this.getDefaultChannelName() : this.getCustomChannelName(result)\n  }\n\n  async getLatestVersion(): Promise<GitlabUpdateInfo> {\n    const cancellationToken = new CancellationToken()\n\n    // Get latest release from GitLab API using the permalink/latest endpoint\n    const latestReleaseUrl = newUrlFromBase(`projects/${this.options.projectId}/releases/permalink/latest`, this.baseApiUrl)\n\n    let latestRelease: GitlabReleaseInfo\n    try {\n      const header = { \"Content-Type\": \"application/json\", ...this.setAuthHeaderForToken(this.options.token || null) }\n      const releaseResponse = await this.httpRequest(latestReleaseUrl, header, cancellationToken)\n\n      if (!releaseResponse) {\n        throw newError(\"No latest release found\", \"ERR_UPDATER_NO_PUBLISHED_VERSIONS\")\n      }\n\n      latestRelease = JSON.parse(releaseResponse)\n    } catch (e: any) {\n      throw newError(`Unable to find latest release on GitLab (${latestReleaseUrl}): ${e.stack || e.message}`, \"ERR_UPDATER_LATEST_VERSION_NOT_FOUND\")\n    }\n\n    const tag = latestRelease.tag_name\n\n    // Look for channel file in release assets\n    let rawData: string | null = null\n    let channelFile = \"\"\n    let channelFileUrl: URL | null = null\n\n    const fetchChannelData = async (channelName: string): Promise<string> => {\n      channelFile = getChannelFilename(channelName)\n\n      // Find the channel file in GitLab release assets\n      const channelAsset = latestRelease.assets.links.find(asset => asset.name === channelFile)\n\n      if (!channelAsset) {\n        throw newError(`Cannot find ${channelFile} in the latest release assets`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n      }\n\n      channelFileUrl = new URL(channelAsset.direct_asset_url)\n      const headers = this.options.token ? { \"PRIVATE-TOKEN\": this.options.token } : undefined\n\n      try {\n        const result = await this.httpRequest(channelFileUrl, headers, cancellationToken)\n        if (!result) {\n          throw newError(`Empty response from ${channelFileUrl}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n        }\n        return result\n      } catch (e: any) {\n        if (e instanceof HttpError && e.statusCode === 404) {\n          throw newError(`Cannot find ${channelFile} in the latest release artifacts (${channelFileUrl}): ${e.stack || e.message}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n        }\n        throw e\n      }\n    }\n\n    try {\n      rawData = await fetchChannelData(this.channel)\n    } catch (e: any) {\n      // If custom channel fails, try default channel as fallback\n      if (this.channel !== this.getDefaultChannelName()) {\n        rawData = await fetchChannelData(this.getDefaultChannelName())\n      } else {\n        throw e\n      }\n    }\n\n    if (!rawData) {\n      throw newError(`Unable to parse channel data from ${channelFile}`, \"ERR_UPDATER_INVALID_UPDATE_INFO\")\n    }\n\n    const result = parseUpdateInfo(rawData, channelFile, channelFileUrl!)\n\n    // Set release name from GitLab if not present\n    if (result.releaseName == null) {\n      result.releaseName = latestRelease.name\n    }\n\n    // Set release notes from GitLab description if not present\n    if (result.releaseNotes == null) {\n      result.releaseNotes = latestRelease.description || null\n    }\n\n    // Create assets map from GitLab release assets\n    const assetsMap = new Map<string, string>()\n    for (const asset of latestRelease.assets.links) {\n      assetsMap.set(this.normalizeFilename(asset.name), asset.direct_asset_url)\n    }\n\n    const gitlabUpdateInfo = {\n      tag: tag,\n      assets: assetsMap,\n      ...result,\n    }\n\n    // Cache the latest version info\n    this.cachedLatestVersion = gitlabUpdateInfo\n\n    return gitlabUpdateInfo\n  }\n\n  /**\n   * Utility function to convert GitlabReleaseAsset to Map<string, string>\n   * Maps asset names to their download URLs\n   */\n  private convertAssetsToMap(assets: GitlabReleaseAsset): Map<string, string> {\n    const assetsMap = new Map<string, string>()\n    for (const asset of assets.links) {\n      assetsMap.set(this.normalizeFilename(asset.name), asset.direct_asset_url)\n    }\n    return assetsMap\n  }\n\n  /**\n   * Find blockmap file URL in assets map for a specific filename\n   */\n  private findBlockMapInAssets(assets: Map<string, string>, filename: string): URL | null {\n    const possibleBlockMapNames = [`${filename}.blockmap`, `${this.normalizeFilename(filename)}.blockmap`]\n\n    for (const blockMapName of possibleBlockMapNames) {\n      const assetUrl = assets.get(blockMapName)\n      if (assetUrl) {\n        return new URL(assetUrl)\n      }\n    }\n    return null\n  }\n\n  private async fetchReleaseInfoByVersion(version: string): Promise<GitlabReleaseInfo | null> {\n    const cancellationToken = new CancellationToken()\n\n    // Try v-prefixed version first, then fallback to plain version\n    const possibleReleaseIds = [`v${version}`, version]\n\n    for (const releaseId of possibleReleaseIds) {\n      const releaseUrl = newUrlFromBase(`projects/${this.options.projectId}/releases/${encodeURIComponent(releaseId)}`, this.baseApiUrl)\n\n      try {\n        const header = { \"Content-Type\": \"application/json\", ...this.setAuthHeaderForToken(this.options.token || null) }\n        const releaseResponse = await this.httpRequest(releaseUrl, header, cancellationToken)\n\n        if (releaseResponse) {\n          const release: GitlabReleaseInfo = JSON.parse(releaseResponse)\n          return release\n        }\n      } catch (e: any) {\n        // If it's a 404 error, try the next release ID format\n        if (e instanceof HttpError && e.statusCode === 404) {\n          continue\n        }\n        // For other errors, throw immediately\n        throw newError(`Unable to find release ${releaseId} on GitLab (${releaseUrl}): ${e.stack || e.message}`, \"ERR_UPDATER_RELEASE_NOT_FOUND\")\n      }\n    }\n\n    // If we get here, none of the release ID formats worked\n    throw newError(`Unable to find release with version ${version} (tried: ${possibleReleaseIds.join(\", \")}) on GitLab`, \"ERR_UPDATER_RELEASE_NOT_FOUND\")\n  }\n\n  private setAuthHeaderForToken(token: string | null): { [key: string]: string } {\n    const headers: { [key: string]: string } = {}\n\n    if (token != null) {\n      // If the token starts with \"Bearer\", it is an OAuth application secret\n      // Note that the original gitlab token would not start with \"Bearer\"\n      // it might start with \"gloas-\", if so user needs to add \"Bearer \" prefix to the token\n      if (token.startsWith(\"Bearer\")) {\n        headers.authorization = token\n      } else {\n        headers[\"PRIVATE-TOKEN\"] = token\n      }\n    }\n\n    return headers\n  }\n\n  /**\n   * Get version info for blockmap files, using cache when possible\n   */\n  private async getVersionInfoForBlockMap(version: string): Promise<Map<string, string> | null> {\n    // Check if we can use cached version info\n    if (this.cachedLatestVersion && this.cachedLatestVersion.version === version) {\n      return this.cachedLatestVersion.assets\n    }\n\n    // Fetch version info if not cached or version doesn't match\n    const versionInfo = await this.fetchReleaseInfoByVersion(version)\n    if (versionInfo && versionInfo.assets) {\n      return this.convertAssetsToMap(versionInfo.assets)\n    }\n\n    return null\n  }\n\n  /**\n   * Find blockmap URLs from version assets\n   */\n  private async findBlockMapUrlsFromAssets(oldVersion: string, newVersion: string, baseFilename: string): Promise<[URL | null, URL | null]> {\n    let newBlockMapUrl: URL | null = null\n    let oldBlockMapUrl: URL | null = null\n\n    // Get new version assets\n    const newVersionAssets = await this.getVersionInfoForBlockMap(newVersion)\n    if (newVersionAssets) {\n      newBlockMapUrl = this.findBlockMapInAssets(newVersionAssets, baseFilename)\n    }\n\n    // Get old version assets\n    const oldVersionAssets = await this.getVersionInfoForBlockMap(oldVersion)\n    if (oldVersionAssets) {\n      const oldFilename = baseFilename.replace(new RegExp(escapeRegExp(newVersion), \"g\"), oldVersion)\n      oldBlockMapUrl = this.findBlockMapInAssets(oldVersionAssets, oldFilename)\n    }\n\n    return [oldBlockMapUrl, newBlockMapUrl]\n  }\n\n  async getBlockMapFiles(baseUrl: URL, oldVersion: string, newVersion: string, oldBlockMapFileBaseUrl: string | null = null): Promise<URL[]> {\n    // If is `project_upload`, find blockmap files from corresponding gitLab assets\n    // Because each asset has an unique path that includes an identified hash code,\n    // e.g. https://gitlab.com/-/project/71361100/uploads/051f27a925eaf679f2ad688105362acc/latest.yml\n    if (this.options.uploadTarget === \"project_upload\") {\n      // Get the base filename from the URL to find corresponding blockmap files\n      const baseFilename = baseUrl.pathname.split(\"/\").pop() || \"\"\n\n      // Try to find blockmap files in GitLab assets\n      const [oldBlockMapUrl, newBlockMapUrl] = await this.findBlockMapUrlsFromAssets(oldVersion, newVersion, baseFilename)\n\n      if (!newBlockMapUrl) {\n        throw newError(`Cannot find blockmap file for ${newVersion} in GitLab assets`, \"ERR_UPDATER_BLOCKMAP_FILE_NOT_FOUND\")\n      }\n\n      if (!oldBlockMapUrl) {\n        throw newError(`Cannot find blockmap file for ${oldVersion} in GitLab assets`, \"ERR_UPDATER_BLOCKMAP_FILE_NOT_FOUND\")\n      }\n\n      return [oldBlockMapUrl, newBlockMapUrl]\n    } else {\n      return super.getBlockMapFiles(baseUrl, oldVersion, newVersion, oldBlockMapFileBaseUrl)\n    }\n  }\n\n  resolveFiles(updateInfo: GitlabUpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return getFileList(updateInfo).map((fileInfo: UpdateFileInfo) => {\n      // Try both original and normalized filename formats\n      const possibleNames = [\n        fileInfo.url, // Original filename\n        this.normalizeFilename(fileInfo.url), // Normalized filename (spaces/underscores â†’ dashes)\n      ]\n\n      const matchingAssetName = possibleNames.find(name => updateInfo.assets.has(name))\n      const assetUrl = matchingAssetName ? updateInfo.assets.get(matchingAssetName) : undefined\n\n      if (!assetUrl) {\n        throw newError(\n          `Cannot find asset \"${fileInfo.url}\" in GitLab release assets. Available assets: ${Array.from(updateInfo.assets.keys()).join(\", \")}`,\n          \"ERR_UPDATER_ASSET_NOT_FOUND\"\n        )\n      }\n\n      return {\n        url: new URL(assetUrl),\n        info: fileInfo,\n      }\n    })\n  }\n\n  toString(): string {\n    return `GitLab (projectId: ${this.options.projectId}, channel: ${this.channel})`\n  }\n}\n"]}