generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Message {
  id        String   @id @default(cuid())
  userId    String
  role      String
  content   String
  channel   String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Thread {
  id        String   @id @default(cuid())
  userId    String
  state     String
  context   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, state])
}

model TriggerLog {
  id          String   @id @default(cuid())
  userId      String
  triggerName String
  actedOn     Boolean  @default(false)
  firedAt     DateTime @default(now())

  @@index([userId, firedAt])
}

model VoiceProfile {
  id             String   @id @default(cuid())
  userId         String
  profileName    String
  cloneType      String
  modelPath      String?
  referenceAudio String?
  createdAt      DateTime @default(now())

  @@index([userId, profileName])
}

model Document {
  id        String   @id @default(cuid())
  userId    String
  title     String
  source    String
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model PairingCode {
  id        String   @id @default(cuid())
  code      String   @unique
  channel   String
  senderId  String
  expiresAt DateTime
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([code])
  @@index([senderId, channel])
}

model ApprovedUser {
  id         String    @id @default(cuid())
  userId     String
  channel    String
  approvedAt DateTime  @default(now())
  revokedAt  DateTime?

  @@unique([userId, channel])
}

model DeviceToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  channel    String
  deviceName String   @default("unknown")
  createdAt  DateTime @default(now())
  lastUsed   DateTime @updatedAt
  revokedAt  DateTime?

  @@index([userId])
}

model PairingSession {
  id        String   @id @default(cuid())
  code      String   @unique
  userId    String
  channel   String
  expiresAt DateTime
  used      Boolean  @default(false)
}

model UserProfile {
  id         String   @id @default(cuid())
  userId     String   @unique
  facts      Json
  opinions   Json
  topics     Json
  updatedAt  DateTime @updatedAt
}

model MemoryNode {
  id         String   @id @default(cuid())
  userId     String
  content    String
  level      Int
  validFrom  DateTime @default(now())
  validUntil DateTime?
  category   String
  embedding  Bytes?
  utilityScore   Float @default(0.5)
  retrievalCount Int   @default(0)
  successCount   Int   @default(0)

  @@index([userId, level])
  @@index([userId, validUntil])
}

model CausalNode {
  id        String   @id @default(cuid())
  userId    String
  event     String
  category  String
  createdAt DateTime @default(now())

  causesEdges CausalEdge[] @relation("from")
  effectEdges CausalEdge[] @relation("to")
  hyperEdges  HyperEdgeMembership[]

  @@index([userId, category])
}

model CausalEdge {
  id        String   @id @default(cuid())
  userId    String
  fromId    String
  toId      String
  strength  Float    @default(0.5)
  evidence  Int      @default(1)
  createdAt DateTime @default(now())

  from CausalNode @relation("from", fields: [fromId], references: [id])
  to   CausalNode @relation("to", fields: [toId], references: [id])

  @@unique([fromId, toId])
  @@index([userId])
}

model HyperEdge {
  id       String   @id @default(cuid())
  userId   String
  relation String
  context  String
  weight   Float    @default(0.5)
  members  HyperEdgeMembership[]

  @@index([userId])
}

model HyperEdgeMembership {
  hyperEdgeId String
  nodeId      String

  hyperEdge HyperEdge  @relation(fields: [hyperEdgeId], references: [id])
  node      CausalNode @relation(fields: [nodeId], references: [id])

  @@id([hyperEdgeId, nodeId])
}
