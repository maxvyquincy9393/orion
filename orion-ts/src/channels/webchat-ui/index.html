<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orion WebChat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141414;
      border-bottom: 1px solid #2a2a2a;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: #1e40af;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      align-self: flex-start;
      background: #1a1a1a;
      border-bottom-left-radius: 4px;
    }

    .input-container {
      padding: 12px 16px;
      background: #141414;
      border-top: 1px solid #2a2a2a;
      display: flex;
      gap: 8px;
    }

    .input-container input {
      flex: 1;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background: #1a1a1a;
      color: #ffffff;
      font-size: 14px;
      outline: none;
    }

    .input-container input::placeholder {
      color: #666;
    }

    .input-container button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #1e40af;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .input-container button:hover {
      background: #2563eb;
    }

    .input-container button:disabled {
      background: #333;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Orion</h1>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected</span>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer"></div>
  
  <div class="input-container">
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
    <button id="sendBtn" disabled>Send</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search)
    const userId = params.get("user") || "owner"
    const port = parseInt(params.get("port") || "8080")
    
    const statusDot = document.getElementById("statusDot")
    const statusText = document.getElementById("statusText")
    const chatContainer = document.getElementById("chatContainer")
    const messageInput = document.getElementById("messageInput")
    const sendBtn = document.getElementById("sendBtn")
    
    let ws = null
    let reconnectInterval = null
    let messageQueue = []

    function setConnected(connected) {
      statusDot.classList.toggle("connected", connected)
      statusText.textContent = connected ? "Connected" : "Disconnected"
      sendBtn.disabled = !connected
      messageInput.disabled = !connected
    }

    function appendMessage(role, content) {
      const div = document.createElement("div")
      div.className = `message ${role}`
      div.textContent = content
      chatContainer.appendChild(div)
      chatContainer.scrollTop = chatContainer.scrollHeight
    }

    function connect() {
      const protocol = location.protocol === "https:" ? "wss:" : "ws:"
      ws = new WebSocket(`${protocol}//${location.hostname}:${port}/ws/${userId}`)

      ws.onopen = () => {
        setConnected(true)
        if (reconnectInterval) {
          clearInterval(reconnectInterval)
          reconnectInterval = null
        }
        while (messageQueue.length > 0) {
          ws.send(messageQueue.shift())
        }
      }

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data)
          if (data.type === "message") {
            appendMessage(data.role || "assistant", data.content)
          }
        } catch (e) {
          appendMessage("assistant", event.data)
        }
      }

      ws.onclose = () => {
        setConnected(false)
        if (!reconnectInterval) {
          reconnectInterval = setInterval(connect, 3000)
        }
      }

      ws.onerror = () => {
        ws.close()
      }
    }

    function sendMessage() {
      const content = messageInput.value.trim()
      if (!content || !ws || ws.readyState !== WebSocket.OPEN) return

      const payload = JSON.stringify({
        type: "message",
        role: "user",
        content: content
      })

      if (ws.readyState === WebSocket.OPEN) {
        ws.send(payload)
        appendMessage("user", content)
        messageInput.value = ""
      } else {
        messageQueue.push(payload)
      }
    }

    sendBtn.addEventListener("click", sendMessage)
    
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage()
      }
    })

    connect()
  </script>
</body>
</html>
